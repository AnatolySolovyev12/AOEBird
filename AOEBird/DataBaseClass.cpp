#include "DataBaseClass.h"

DataBaseClass::DataBaseClass(QObject *parent)
	: QObject(parent)
{}



DataBaseClass::~DataBaseClass()
{
	if (mainDbConnection.isOpen()) 
	{
		mainDbConnection.close();
	}

	if (QSqlDatabase::contains("postgres_connection")) 
	{
		QSqlDatabase::removeDatabase("postgres_connection");
	}
}



void DataBaseClass::connectionToMainDb(QStringList signalList)
{
	mainDbConnection = QSqlDatabase::addDatabase("QPSQL", "postgres_connection");
	mainDbConnection.setHostName(signalList[0]);
	mainDbConnection.setPort(signalList[1].toInt());  // По умолчанию 5432
	mainDbConnection.setDatabaseName(signalList[2]);
	mainDbConnection.setUserName(signalList[3]);
	mainDbConnection.setPassword(signalList[4]);

	if (!mainDbConnection.open())
	{
		qDebug() << "Error in DataBaseClass::connectionToMainDb() when try to OPEN database." << "\nError text:\n" << mainDbConnection.lastError().text();
	}
	else
	{
		qDebug() << "OPEN " << signalList[2];
		
		createMainTables();
	}
}



void DataBaseClass::createMainTables()
{
	QSqlQuery query(mainDbConnection);

	if (!query.exec("CREATE TABLE IF NOT EXISTS queue_notice (id_user INT, id_request INT, id_position INT, phone_number VARCHAR(14), mail VARCHAR(40), max_send BOOLEAN, tg_send BOOLEAN, sms_send BOOLEAN, date DATE, time TIME);"))
	{
		qDebug() << "Error in DataBaseClass::connectionToMainDb() when try to create queue_notice table. Query:\n" << query.lastQuery() << "\nError text:\n" << query.lastError().text();
	}
	else
		qDebug() << "TABLE queue_notice WAS ADD OR SKIP";

	if (!query.exec("CREATE TABLE IF NOT EXISTS history (id_user INT, id_request INT, id_position INT, phone_number VARCHAR(14), mail VARCHAR(40), max_send BOOLEAN, tg_send BOOLEAN, sms_send BOOLEAN, date DATE, time TIME);"))
	{
		qDebug() << "Error in DataBaseClass::connectionToMainDb() when try to create history table. Query:\n" << query.lastQuery() << "\nError text:\n" << query.lastError().text();
	}
	else
		qDebug() << "TABLE history WAS ADD OR SKIP";

	if (!query.exec("CREATE TABLE IF NOT EXISTS users (id_user INT GENERATED BY DEFAULT AS IDENTITY, mail VARCHAR(25) PRIMARY KEY, password VARCHAR(25), date DATE, time TIME);"))
	{
		qDebug() << "Error in DataBaseClass::connectionToMainDb() when try to create users table. Query:\n" << query.lastQuery() << "\nError text:\n" << query.lastError().text();
	}
	else
		qDebug() << "TABLE users WAS ADD OR SKIP";



	QString tempString = QString("INSERT INTO users (mail, password, date, time) VALUES ('ass123123@mail.ru', 'asspass', '%1', '%2');").arg(QDate::currentDate().toString()).arg(QTime::currentTime().toString());


	if (!query.exec(tempString))
	{
		qDebug() << "Error in DataBaseClass::connectionToMainDb() when try to insert test value. Query:\n" << query.lastQuery() << "\nError text:\n" << query.lastError().text();
	}
	else
		qDebug() << "TEST VALUE was add in users";






}